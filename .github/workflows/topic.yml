# .github/workflows/update-topics.yml
name: Update Topics

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-topics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Detect Python libraries dynamically
        id: detect
        run: |
          TOPICS=""

          if [ -f requirements.txt ]; then
            while IFS= read -r line; do
              # Supprimer espaces en début/fin
              line=$(echo "$line" | xargs)
              # Ignorer les lignes vides ou commentaires
              if [ -z "$line" ] || [[ "$line" =~ ^# ]]; then
                continue
              fi
              # Extraire le nom avant == ou > ou <
              LIB=$(echo "$line" | sed -E 's/[<>=].*//')
              # Remplacer underscores par tirets
              LIB_FORMATTED=$(echo "$LIB" | sed 's/_/-/g' | awk '{print toupper(substr($0,1,1)) substr($0,2)}')
              TOPICS="$TOPICS,$LIB_FORMATTED"
            done < requirements.txt
          fi

          # Nettoyage
          TOPICS=$(echo $TOPICS | sed 's/^,//; s/,,/,/g')
          echo "TOPICS=$TOPICS" >> $GITHUB_ENV

      - name: Set repository topics
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAT_GITHUB }}   # ← ton secret existant
          script: |
            const topics = process.env.TOPICS.split(',').map(t => t.trim());
            await github.rest.repos.replaceAllTopics({
              owner: context.repo.owner,
              repo: context.repo.repo,
              names: topics
            });
